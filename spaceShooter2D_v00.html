<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>rotate items in canvas</title>

    <script
  src="http://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #333;
        }
        #myCanvas {
            border: 1px solid grey;
        }
    </style>
</head>
<body>
    <p style="color: #CCC">
        turn: l/r arrows, thrust: up arrow, fire: spacebar
    </p>
    
    <canvas id="myCanvas" width="1000" height="800"></canvas>

    <script>
        var AsteroidsNameSpace = (function(){            
            
            let Game = (function(){
                // "Singleton" of sorts
                // Turning into a Catch-all
                let Game = {};
                let _intervalId = null;
                let _fps = 30;
                let _lastTick = (new Date).getTime();
                let _timeStep = 1000/_fps;
                Game.timeStep = _timeStep;
                Game.strokeColor = "#CCCCCC";
                Game.fillColor = Game.strokeColor;
                Game.shots = [];
                Game.opponents = [];
                Game.debris = [];
                Game.currentTime = (new Date).getTime();
                Game.nextOpponentTime = Game.currentTime + 5000;
                Game.gameOver = false;

                Game.run = function() {
                    // Main Game Loop
                    Game.currentTime = (new Date).getTime();
                    let elapsed = Game.currentTime - _lastTick;
                    _lastTick = Game.currentTime;
                    
                    // Move Everything
                    Game.moveItems( Game.shots );
                    Game.moveItems( Game.opponents );
                    Game.moveItems( Game.debris );
                    // Check Collisions
                    Game.checkCollisions( Game.shots, Game.opponents );
                    if ( playerShip.alive ) {
                        // Check Input
                        Game.checkKeys();
                        playerShip.move();
                        Game.flyOpponents();
                        Game.keepInBounds(playerShip);
                        Game.checkCollisions( [playerShip], Game.shots );
                        Game.checkCollisions( [playerShip], Game.opponents );      
                    }
                    
                    // Do the drawing
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
                    playerShip.draw();
                    Game.drawItems( Game.shots );
                    Game.drawItems( Game.opponents );
                    Game.drawItems( Game.debris );

                    if ( Game.currentTime > Game.nextOpponentTime && Game.opponents.length < 3 && ! Game.gameOver ) {
                        Game.spawnOpponent();
                        Game.nextOpponentTime = Game.currentTime + 5000;
                    }
                }

                Game.start = function(){
                    _intervalId = setInterval(Game.run, _timeStep);
                }
                Game.stop = function() {
                    clearInterval( _intervalId );
                }
                Game.respawnPlayer = function () {
                    // wait 1 sec
                    _timeoutId = setTimeout( function() {
                        Game.spawnPlayer();
                    }, 1000 );
                }
                Game.spawnPlayer = function () {
                    // select position
                    let x = Math.random() * canvas.width;
                    let y = Math.random() * canvas.width;
                    let duration = 1500;
                    _timeoutId = setTimeout( function() {
                        // show Player at x/y
                        playerShip.spawn(x,y);
                    }, duration );
                    Game.implode(x,y,duration);
                }
                Game.keepInBounds = function( element ) {
                    if ( element.x > canvas.width ) {
                        element.x -= canvas.width;
                    } else if ( element.x < 0 ) {
                        element.x += canvas.width;
                    }
                    if ( element.y > canvas.height ) {
                        element.y -= canvas.height;
                    } else if ( element.y < 0 ) {
                        element.y += canvas.height;
                    }   
                }
                Game.moveItems = function ( ar ) {
                    for ( let item of ar ) {
                        item.move();
                        Game.keepInBounds( item );
                    }
                }
                Game.drawItems = function ( ar ) {
                    for ( let item of ar ) {
                        item.draw();
                    }
                }
                Game.flyOpponents = function () {
                    for ( let opponent of Game.opponents ) {
                        let radToPlayer = Math.atan2( playerShip.y - opponent.y, playerShip.x - opponent.x );
                        // Get angle diff of angle to player vs opponent's facing
                        let deg = degDiff( radToDeg( radToPlayer ), opponent.rotation );
                        if ( Math.abs(deg) < 90 ) {
                            opponent.thrust();
                            if ( Math.abs(deg) < 10 ) {
                                opponent.shoot();
                            }
                        }
                        if ( deg > 0 ) {
                            opponent.turnRight(2);
                        } else if ( deg < 0 ) {
                            opponent.turnLeft(2);
                        }
                    }
                }

                Game.spawnOpponent = function() {
                    let x = canvas.width * Math.random();
                    let y = canvas.height * Math.random();
                    let opponentShip = new Ship(20,30,x,y,0);
                    // Game.opponents.push(opponentShip);
                    opponentShip.myArray = Game.opponents;
                }
                
                Game.checkCollisions = function ( groupA, groupB ) {
                    for ( let A of groupA ) {
                        for ( let B of groupB ) {
                            if ( Game.checkCollision ( A, B ) ) {
                                A.kill();
                                Game.explode(B.x,B.y);
                                B.kill();
                            }
                        }
                    }
                }
                Game.checkCollision = function ( A, B ) {
                    // Does center of A move through circle of B this frame? 
                    let Ax0 = A.x-A.xspeed,
                        Ax1 = A.x;
                    let hitTime = circleSweepTest( A, B );
                    let hit = hitTime <= 1 && hitTime >= 0;
                    return hit;
                }
                Game.explode = function(x,y) {
                    for ( let i = 0; i < 40; i++ ) {
                        let maxSpeed = 10
                        let speed = 1+Math.random()*(maxSpeed-1);
                        let rad = degToRad(Math.random() * 360);
                        let xspeed = Math.cos(rad) * speed;
                        let yspeed = Math.sin(rad) * speed;
                        let diameter = (maxSpeed+4-speed)*0.5;
                        let lifespan = 1000 + 500*(speed/maxSpeed);
                        let debris = new Debris(x,y,xspeed,yspeed,diameter,lifespan);
                        debris.myArray = Game.debris;
                    }
                }
                Game.implode = function(endx,endy,dur) {
                    let maxDist = 1000;
                    let minDist = 100;
                    let maxSpeed = maxDist / Game.timeStep;
                    let numSteps = dur / Game.timeStep;
                    for ( let i = 0; i < 40; i++ ) {
                        let dist = minDist + Math.random() * (maxDist-minDist);
                        let speed = dist / numSteps;
                        let rad = degToRad(Math.random() * 360);
                        let xspeed = Math.cos(rad) * speed;
                        let yspeed = Math.sin(rad) * speed;
                        let x = endx - xspeed * numSteps;
                        let y = endy - yspeed * numSteps;
                        let diameter = Math.random()*12*0.5;
                        let debris = new Debris(x,y,xspeed,yspeed,diameter,dur);
                        debris.myArray = Game.debris;
                    }
                }

                Game.checkKeys = function () {
                    for ( let key of Game.keys ) {
                        if ( key && key.isDown && key.downFunc ) {
                            key.downFunc();
                        }
                    }
                }

                Game.keys = new Array();
                Game.setKey = function(name,keyCode,downFunc,upFunc){
                    Game.keys[keyCode] = { name : name, isDown : false, downFunc : downFunc, upFunc : upFunc == undefined ? null : upFunc };
                }
                Game.keyDown = function ( keycode ) {
                    if ( Game.keys[keycode] ) {
                        // if ( Game.keys[keycode].downFunc != undefined ) {
                        //     Game.keys[keycode].downFunc();
                        // }
                        Game.keys[keycode].isDown = true;
                    }
                }
                Game.keyUp = function ( keycode ) {
                    if ( Game.keys[keycode] ) {
                        let key = Game.keys[keycode];
                        if ( key.upFunc != undefined ) {
                            key.upFunc();
                        }
                        key.isDown = false;
                    }
                }
                return Game;
            })();

            



            /*          
            ============================================

                        GAME ELEMENT CLASS

            ============================================
            */
            class GameElement {
                constructor () {
                    console.log("GameElement.constructor()")
                }
                init ( x, y, rot, w, h ) {
                    console.log("GameElement.init()")
                    this._myArray = null;
                    this._x = x ? x : 0;
                    this._y = y ? y : 0;
                    this._rot = rot ? rot : 0;
                    this._width = w ? w : 0;
                    this._height = h ? h : 0;
                }
                predraw () {
                    ctx.translate( this.x, this.y );
                    const radian = degToRad( this._rot );
                    ctx.rotate( radian );
                }
                draw () {
                    
                    // Draw my shape
                   
                }
                postdraw () {
                    ctx.rotate( -degToRad( this._rot ) );
                    ctx.translate( -this.x, -this.y );
                }
                move () {
                    this.x += this.xspeed;
                    this.y += this.yspeed;
                }
                kill () {
                    // console.log("kill element");
                    // remove me from myArray
                    if ( this.myArray ) {
                        let i = this.myArray.indexOf( this );
                        this.myArray.splice( i, 1 );
                    }
                    // Kill me
                    delete this;
                }

                get x () {
                    return this._x;
                }
                set x ( value ) {
                    this._x = value;
                }

                get y () {
                    return this._y;
                }
                set y ( value ) {
                    this._y = value;
                }

                get rotation () {
                    return this._rot;
                }
                set rotation ( value ) {
                    value = value % 360;
                    this._rot = value;
                }

                get width () {
                    return this._width;
                }
                set width ( value ) {
                    if ( typeof value == 'number' ) {
                        this._width = value;
                    }
                }

                get height () {
                    return this._height;
                }
                set height ( value ) {
                    if ( typeof value == 'number' ) {
                        this._height = value;
                    }
                }

                set xspeed ( value ) {
                    if ( typeof value == 'number' ) {
                        this._xspeed = value;
                    }
                }
                get xspeed () {
                    return this._xspeed;
                }

                set yspeed ( value ) {
                    if ( typeof value == 'number' ) {
                        this._yspeed = value;
                    }
                }
                get yspeed () {
                    return this._yspeed;
                }

                set myArray ( value ) {
                    if ( Array.isArray( value) ) {
                        this._myArray = value;
                        this._myArray.push( this );
                    }
                }
                get myArray () {
                    return this._myArray;
                }
            }


            /*          
            ============================================

                        TRIANGLE CLASS

            ============================================
            */
            class Triangle extends GameElement {
                constructor ( width, height, x, y, rot ) {
                    console.log("Triangle.constructor()")
                    super();
                    super.init(x,y,rot,width,height);
                    this.init();
                }
                init () {
                    console.log("Triangle.init()")
                    this._strokeColor = Game.strokeColor;
                }
                draw () {
                    // Draw Triangle
                    ctx.strokeStyle = this._strokeColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();

                    ctx.moveTo( this.height*0.5, 0 );
                    ctx.lineTo( -this.height*0.5, -this.width * 0.5 );
                    ctx.lineTo( -this.height *0.5, this.width*0.5 );
                    ctx.lineTo( this.height*0.5, 0 );

                    ctx.stroke();
                }
                set strokeColor (value) {
                    this._strokeColor = value;
                }
            }

            /*
            ============================================

                        SHIP CLASS

            ============================================
            */
            class Ship extends Triangle {
                constructor(w,h,x,y,rot) {
                    console.log("Ship.constructor()")
                    super (w,h,x,y,rot);
                    this.init();
                }
                init () {
                    console.log("Ship.init()")
                    super.init();
                    this._lastShotTime = 0;
                    this._liveShots = 0;
                    this._maxShots = 4;
                    this._shotFrequency = 100;
                    this._shotPower = 10;
                    this._xspeed = 0;
                    this._yspeed = 0;
                    this._maxthrust = 15;
                    this._thrust = 0;
                }
                draw () {
                    this.predraw();
                    super.draw();

                    if ( this._thrust > 0 ) {
                        // Draw thrust
                        ctx.moveTo( -this.height*0.5, -this.width*0.2 );
                        ctx.lineTo( -this.height*0.5, this.width * 0.2 );
                        ctx.lineTo( -this.height * 0.75, 0 );
                        ctx.lineTo( -this.height*0.5, -this.width*0.2 );
                        ctx.stroke();
                    }
                    this.postdraw();
                }
                turnRight ( value ) {
                    this.rotation += value ? value : 5;
                }
                turnLeft ( value ) {
                    this.rotation -= value ? value : 5;
                }
                shoot () {
                    if ( this.liveShots < this._maxShots && Game.currentTime > this._lastShotTime + this._shotFrequency ) {
                        let cos = Math.cos(this.radian);
                        let sin = Math.sin(this.radian);
                        let nosex = this.x + cos * this.height * 0.75;
                        let nosey = this.y + sin * this.height * 0.75;
                        let xspeed = this.xspeed + cos * this._shotPower;
                        let yspeed = this.yspeed + sin * this._shotPower;
                        let shot = new Shot( nosex, nosey, xspeed, yspeed, this );
                        shot.myArray = Game.shots;

                        this.liveShots++;
                        this._lastShotTime = Game.currentTime;
                    }
                    
                }
                thrust () {
                    this._thrust += 2;
                    this._thrust = Math.min ( this._thrust, this._maxthrust );
                    let radian = degToRad( this.rotation );
                    let xthrust = Math.cos(radian)*this._thrust;
                    let ythrust = Math.sin(radian)*this._thrust;
                    this.xspeed = (this.xspeed * 15 + xthrust) / 16;
                    this.yspeed = (this.yspeed * 15 + ythrust) / 16;
                }
                move () {
                    super.move();
                    // Deceleration
                    if ( this._thrust > 0 ) {
                        this._thrust -= 1;
                    }
                    this.xspeed *= 0.99;
                    this.yspeed *= 0.99;
                    if ( Math.abs(this.xspeed) < 0.5 && Math.abs(this.yspeed) < 0.5 ) {
                        this.xspeed = this.yspeed = 0;
                    }
                }
                get radian () {
                    return degToRad(this.rotation);
                }

                set liveShots ( value ) {
                    if ( typeof value == 'number' ) {
                        this._liveShots = value;
                    }
                }
                get liveShots () {
                    return this._liveShots;
                }
                
            }

            /*
            ============================================

                        PLAYER SHIP CLASS

            ============================================
            */
            class PlayerShip extends Ship {
                constructor (w,h,x,y,rot) {
                    super (w,h,x,y,rot);
                    this._alive = true;
                    this._maxShots = 6;
                    this._shotFrequency = 80;
                    this._shotPower = 12;
                }
                draw () {
                    if ( this._alive ) {
                        super.draw();
                    }
                }
                kill () {
                    if ( this._alive ) {
                        // Game.gameOver = true;
                        Game.respawnPlayer();
                        // super.kill();
                        this._alive = false;
                        this.x = 0;
                        this.y = 0;
                    }
                }
                spawn (x,y) {
                    this.x = x;
                    this.y = y;
                    this.xspeed = this.yspeed = 0;
                    this._thrust = 0;
                    this._alive = true;
                }
                get alive () {
                    return this._alive;
                }
            }

            /*
            ============================================

                        SHOT CLASS

            ============================================
            */

            class Shot extends GameElement {
                constructor (x, y, xspeed, yspeed, ship) {
                    super();
                    this.x = x;
                    this.y = y;
                    this.xspeed = xspeed;
                    this.yspeed = yspeed;
                    this.myShip = ship;
                    this.init();
                }
                init() {
                    this._startTime = Game.currentTime;
                    this._lifeSpan = 2000;
                    this.width = 5;
                    this.height = 5;
                }
                move () {
                    super.move();
                    
                    this._totalDistance += hypotenuse( this.xspeed, this.yspeed );
                    if ( Game.currentTime >= this._startTime + this._lifeSpan ) {
                        this.kill();
                    }
                }
                draw () {
                    // Draw a circle
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = Game.fillColor;
                    ctx.fill();
                }
                kill () {
                    super.kill();
                    this.myShip.liveShots --;
                }
            }

            /*
            ============================================

                        DEBRIS CLASS

            ============================================
            */
            class Debris extends GameElement {
                constructor (x,y,xspeed,yspeed,diameter,lifespan) {
                    super();
                    this._killTime = Game.currentTime + lifespan;
                    this.x = x;
                    this.y = y;
                    this.xspeed = xspeed;
                    this.yspeed = yspeed;
                    this.width = this.height = diameter;
                }
                init () {

                }
                move () {
                    super.move();
                    Game.keepInBounds(this);
                    if ( Game.currentTime >= this._killTime ) {
                        this.kill();
                    }
                }
                draw () {
                    // Draw a circle
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = Game.fillColor;
                    ctx.fill();
                }

            }

            /*          
            ============================================

                        POINT OF ENTRY

            ============================================
            */
            const canvas = document.getElementById('myCanvas');
            const ctx = canvas.getContext('2d');
            let playerShip = new PlayerShip(10,20,100,100,0);
            Game.spawnOpponent();
            
            Game.start();

            // const triangle1 = new Triangle( 10, 20 );
            // triangle1.x = 100;
            // triangle1.y = 100;
            // triangle1.rotation = 90;
            // triangle1.draw();

            // const triangle2 = new Triangle( 10, 20 );
            // triangle1.x = 200;
            // triangle1.y = 100;
            // triangle1.rotation = -90;
            // triangle1.draw();

            /*          
            ============================================

                        UTILITIES

            ============================================
            */

            function radToDeg (rad) {
                return rad * 180 / Math.PI;
            }
            function degToRad (deg) {
                return deg *  Math.PI / 180; 
            }

            function hypotenuse (a,b){
                return Math.sqrt(a*a+b*b);
            }

            function degDiff (deg2, deg1) {
                // console.log("degDif("+deg1+", "+deg2+")")
                // console.log("diff: "+(deg2%180 - deg1%180))
                return deg2%180 - deg1%180;
            }

            function circleSweepTest( sprite1, sprite2 ) {
                // circ1 and circ2 are Unit objects
                // algorithm from:  http://compsci.ca/v3/viewtopic.php?t=14897
                let Axv = sprite1.xspeed,
                    Ayv = sprite1.yspeed,
                    Bxv = sprite2.xspeed,
                    Byv = sprite2.yspeed;

                var maxint = 10000;
                /* Returns the amount of frames untill a collision will occur */ 
                var t = maxint;
                var A, B, C, D, DISC;
                /* Breaking down the formula for t */ 
                A = Math.pow( Axv, 2 ) + Math.pow( Ayv, 2 ) - 2 * Axv * Bxv + Math.pow( Bxv, 2 ) - 2 * Ayv * Byv + Math.pow( Byv, 2 );
                B = -sprite1.x * Axv - sprite1.y * Ayv + Axv * sprite2.x + Ayv * sprite2.y + sprite1.x * Bxv - sprite2.x * Bxv + sprite1.y * Byv - sprite2.y * Byv;
                C = Math.pow( Axv, 2 ) + Math.pow( Ayv, 2 ) - 2 * Axv * Bxv + Math.pow( Bxv, 2 ) - 2 * Ayv * Byv + Math.pow( Byv, 2 );
                D = Math.pow( sprite1.x, 2 ) + Math.pow( sprite1.y, 2 ) - Math.pow( sprite1.width*0.5, 2 ) - 2 * sprite1.x * sprite2.x + Math.pow( sprite2.x, 2 ) - 2 * sprite1.y * sprite2.y + Math.pow( sprite2.y, 2 ) - 2 * sprite1.width*0.5 * sprite2.width*0.5 - Math.pow( sprite2.width*0.5, 2 );
                DISC = Math.pow( (-2 * B), 2 ) - 4 * C * D;

                /* If the discriminent if non negative, a collision will occur and * 
                * we must compare the time to our current time of collision. We   * 
                * udate the time if we find a collision that has occurd earlier   * 
                * than the previous one.                                          */ 
                if ( DISC >= 0 ) {
                    /* We want the smallest time */ 
                    t = Math.min (Math.min (t, 0.5 * (2 * B - Math.sqrt (DISC)) / A), 0.5 * (2 * B + Math.sqrt (DISC)) / A);
                }
                return t;
            }

            /*
            ============================================

                            KEY LISTENERS

            ============================================
            */

            Game.setKey ( "left", 37, () => playerShip.turnLeft() );
            Game.setKey ( "right", 39, () => playerShip.turnRight() );
            Game.setKey ( "thrust", 38, () => playerShip.thrust() );
            Game.setKey ( "thrust", 93, () => playerShip.thrust() );
            Game.setKey ( "thrust", 91, () => playerShip.thrust() );
            Game.setKey ( "fire", 32, () => playerShip.shoot() );

            $(document.body).keydown( function(e) {
                console.log("keydown: "+e.which);
                Game.keyDown(e.which);
                e.preventDefault();
            });
            $(document.body).keyup( function(e) {
                Game.keyUp(e.which);
                e.preventDefault();
            })

        })();



            

       
    </script>
</body>
</html>